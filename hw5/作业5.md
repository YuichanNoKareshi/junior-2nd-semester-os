# 《文件系统》章节练习

#### 1. 符号连接和硬链接是访问文件的两种捷径方式，但是它们在使用和实现上有许多不同。请列举出至少4点不同。
+ hard link没有创建新文件，symlink创建了一个新文件，记录文件名
+ hard link目标inode的refcnt增加了，symlink目标inode的refcnt不变
+ hard link被link的文件被删除后link仍然有效，symlink被link的文件被删除后link无效，无法访问
+ symlink可以指向目录，hard link不可以

#### 2. 在某些文件系统中，例如ext4，不允许使用硬链接来链接目录。 
1. 请举一个例子说明如果文件系统支持到目录的硬链接会出现什么问题。 
&emsp;&emsp;当前目录结构为x/a/b，现在LINk("./a/b/c","a")，当UNLINK("./a")时，refcnt变为1，但b和c不可达，inode不可删除

2. 如果确实需要支持到目录的硬链接，那么如何设计文件系统？并且，请从复杂性和性能等方面分析您的设计。 
&emsp;&emsp;可以在UNLINK前检查是否为目录，如果是则检查当前文件和子文件的LINK是否成环，若成环则全部UNLINK
&emsp;&emsp;每次UNLINK目录时会耗费O(n)的世界，但是因为对目录的LINK不会太多，所以性能影响不算太大

#### 3. 请给出一个由于系统崩溃而导致的文件系统不一致的例子。 
&emsp;&emsp;创建文件时，会标记inode为占用、初始化inode以及将目录项写入目录，如果先写入目录项随后系统崩溃，会导致目录项指向了未分配的inode

#### 4. 什么是文件系统的持久性和原子性？如何保证文件系统操作的持久性和原子性？ 
+ 持久性指一些操作执行后文件系统保持执行后的状态；原子性指一些操作要么全都做了要么全都没做，不能出现部分做了部分没做的情况
+ 文件系统可以使用日志来保证操作的持久性和原子性

#### 5. 有三种支持一致性的技术：写时复制，journal和log-structured update。 
1. 请解释它们之间的区别。 
+ 写时复制：在修改多个数据时，不直接修改数据，而是将数据复制一份，在复制上进行修改，并通过递归的方法将修改变成原子操作。常用于树状结构
+ journal是在内存中进行文件系统操作的同时，在磁盘上用日志同时记录元数据和数据，以实现原子操作
+ log-structured(日志文件系统) update是将文件系统的修改以日志的方式顺序写入存储设备

2. 如何在不同的情况下选择这些技术？请给出一些各个技术所适合的场景。
+ 每次修改都接近整块，而且在磁盘中局部性较好时适合用写时复制
+ 不会引起级联的修改，多次小的修改适合用日志

#### 6. 对于闪存的磨损问题，文件系统如何在短时间内避免其导致闪存容量下降的问题？如果某些块已用完，文件系统如何处理它们？ （假设硬件提供了某种方式来报告块是否已磨损。）
&emsp;&emsp;可以通过FTL实现读写和擦除非对称，把需要频繁读写的块迁移到别的位置，从而实现负载均衡。


